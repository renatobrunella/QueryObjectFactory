<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
		
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<link rel="stylesheet" type="text/css" href="qof.css" media="screen" title="qof" />
<link rel="stylesheet" type="text/css" href="qof-print.css" media="print" title="qof" />
<script src="codepress/codepress.js" type="text/javascript"></script>
<!--[if lt IE 7.]>
<script defer type="text/javascript" src="scripts/pngfix.js"></script>
<![endif]-->

<title>Query Object Factory - Tutorials</title>
</head>
<body>
<div id="masthead">
	<h1>
		<a href="http://sourceforge.net/">SourceForge.net</a>
	</h1>
	<div id="qoflogo">
		<a href="index.html"><img src="images/qof-line.png" border="0" />
		<img src="http://sflogo.sourceforge.net/sflogo.php?group_id=204175&amp;type=1" width="0" height="0" border="0" alt="" />
	</div>
</div>

<div id="leftColumn">
<div id="navColumn" style="height:2500px;">
<h1>About</h1>
<ul>
  <li class="none"><a href="index.html">Overview</a></li>
  <li class="none"><a href="introduction.html">Introduction</a></li>
  <li class="none"><a href="api/index.html">Javadoc</a></li>
  <li class="none"><a href="http://sourceforge.net/project/showfiles.php?group_id=204175#downloads">Downloads</a></li>
  <li class="none"><a href="http://sourceforge.net/news/?group_id=204175">News</a></li>
  <li class="none"><a href="faq.html">FAQ</a></li>
  <li class="none"><a href="license.html">License</a></li>
 <!--     
      <li class="none"><a href="goals.html">Our Goals</a></li>
   -->
</ul>

<h1>Tutorial</h1>
<ul>
  <li class="none"><a href="tutorials.html">Tutorials</a></li>
  <li class="none"><a href="tutorial-quick-start.html">&nbsp; &nbsp;Quick Start</a></li>
  <li class="none">&nbsp; &nbsp;<strong>Immutable Objects</strong></li>
  <li class="none"><a href="tutorial-inclause.html">&nbsp; &nbsp;In-Clause</a></li>
</ul>

<h1>Core Concepts</h1>
<ul>
  <li class="none">Coming soon</li>
</ul>

<h1>Architecture</h1>
<ul>
  <li class="none">Coming soon</li>
</ul>

</div>
</div>

<div id="bodyColumn">
<div id="contentBox">
<div class="section">
<h2>Immutable Object Tutorial</h2>

<p>Author: Renato Brunella</p>

<p>This tutorial demonstrates how immutable objects can be mapped. Immutable objects get their state during initialzation through parameters
in the constructor. The example is an exchange rate calculator that reads the exchange rates from the database.</p>

</div>

<div class="section">
<h4>Tutorial Files</h4>
  
<p>You can find the source code in the 
<a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/immutable/" target="_blank">Code Repository</a>
in the <code>sf.qof.tutorial.immutable</code> package.</p>
<p>
<table>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/immutable/ExchangeRateCalculator.java?view=markup" target="_blank">ExchangeRateCalculator.java&nbsp; &nbsp;</a></td>
<td>This file contains the main command line control loop.</td>
</tr>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/immutable/Currency.java?view=markup" target="_blank">Currency.java</a></td>
<td>An immutable currency object.</td>
</tr>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/immutable/CurrencyCode.java?view=markup" target="_blank">CurrencyCode.java</a></td>
<td>A currency code enumeration (USD, GBP, etc).</td>
</tr>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/immutable/DatabaseSetup.java?view=markup" target="_blank">DatabaseSetup.java</a></td>
<td>Database setup.</td>
</tr>
</table>  
</div>

<div class="section">
<h4>Running the Tutorial</h4>

<p>Make sure you built the tutorial jar using Ant.<p>
<p>Use</p><code>java -cp dist/qof-tutorial-1.0.0.jar;lib/qof-1.0.0.jar;lib/cglib-2.1_3.jar;lib/asm-1.5.3.jar;lib/hsqldb.jar sf.qof.tutorial.immutable.ExchangeRateCalculator</code>
<p>to run the example (replace ; with : on Unix based systems).</p>
<p>Alternatively under Windows you can use the <code>run.bat</code> batch file:</p>
<code>run.bat sf.qof.tutorial.immutable.ExchangeRateCalculator</code>
</div>

<div class="section">
<h4>Source Code Walkthrough</h4>

<p>The <code>Currency</code> class is immutable i.e. once it is initialized with a state this state cannot be changed anymore. 
Therefore it cannot have any setter methods and the state must be passed in through the constructor:</p>

<textarea id="ta1" class="codepress java readonly-on" style="width:650px;height:350px;" wrap="off">
package sf.qof.tutorial.immutable;

public class Currency {

  private double exchangeRateInUSD;
  private CurrencyCode currencyCode;

  public Currency(CurrencyCode currencyCode, double amount) {
    this.currencyCode = currencyCode;
    this.exchangeRateInUSD = amount;
  }
  
  public double getExchangeRateInUSD() {
    return exchangeRateInUSD;
  }
  
  public CurrencyCode getCurrencyCode() {
    return currencyCode;
  }
}
</textarea>

<p>In the <a href="introduction.html">Introduction</a> we saw an example of how to map database columns 
to fields in objects using setter methods and here we will show how the mapping to parameters in a constructor
work. Further we will show how to use custom mapping adapters to map enumerations.</p>

<p>The <code>ExchangeRateCalculator</code> class has a <code>main</code> method that creates a new instance of
<code>ExchangeRateCalculator</code> and calls <code>run()</code> displaying all supported currencies and waits 
for some user input.</p>

<p>The constructor of <code>ExchangeRateCalculator</code> first sets up the database with default values then
registers a custom mapping adapter and initializes the currency cache with the values from the database:</p>

<blockquote><pre>
  <b style="color:#7F0055;">private</b> ExchangeRateCalculator() <b style="color:#7F0055;">throws</b> SQLException {
    DatabaseSetup.setup();
    ExchangeRateDAO dao = 
	  QueryObjectFactory.createQueryObject(ExchangeRateDAO.<b style="color:#7F0055;">class</b>);
    Connection connection = DataSourceFactory.getDataSource().getConnection();
    dao.setConnection(connection);
    currencyCache = dao.retrieveExchangeRates();
    connection.close();
  }
  
  <b style="color:#7F0055;">private</b> Map&lt;CurrencyCode, Currency&gt; currencyCache;
</pre></blockquote>

<p>The currecy cache is defined as a map with a key of <code>CurrencyCode</code> enumeration and value of <code>Currency</code>.</p>

<p>Let's have a look at <code>ExchangeRateDAO</code> the query interface definition to see how we can initialize
the currency cache:</p>

<blockquote><pre>
  <b style="color:#7F0055;">private</b> <b style="color:#7F0055;">interface</b> ExchangeRateDAO <b style="color:#7F0055;">extends</b> BaseQuery {
    @Query(sql = <b style="color: #0000FF;font-weight:normal;">"select currency_code {enum%%1,enum%%*}, " +
	  "exchange_rate {double%%2} from exchange_rate"</b>)
    Map&lt;CurrencyCode, Currency&gt; retrieveExchangeRates() <b style="color:#7F0055;">throws</b> SQLException;
  }
</pre></blockquote>

<p>The SQL select statement simply selects two columns <code>currency_code</code> and <code>exchange_rate</code> from 
the exchange_rate table. We want to use the <code>currency_code</code> column as the key for values in the result <code>Map</code>. 
This is done using two percent characters followed by a star and because enumeration mapping uses a custom mapping adapter
we need to specify the type "enum": <code><b>{enum%%*}</b></code>.</p>

<p>The value in the map is of type <code>Currency</code> and we need to use the constructor:</p>

<blockquote><pre>
  <b style="color:#7F0055;">public</b> Currency(CurrencyCode currencyCode, double amount)
</pre></blockquote>

<p>It takes two parameters of type <code>CurrencyCode</code> and <code>double</code>. To map to a parameter in the constructor
you need to define a result mapping with type followed by two percent charaters and followed by the parameter index: 
<code><b>{enum%%1}</b></code> and <code><b>{double%%2}</b></code>. The type must to be defined to enable QueryObjectFactory to 
select the correct constructor.</p>

<p>QueryObjectFactory will try to find a matching constructor in <code>Currency</code> that has two parameters of type <code>Enumeration</code>
and <code>double</code>. If no matching constructor can be found an exception is thrown.</p>

<p>The result set column <code>currency_code</code> is mapped to both the key in the map and the first parameter in the constructor
of <code>Currency</code>. This is done using <code><b>{enum%%1,enum%%*}</b></code>.</p>

<p>To enable mapping of enumerations we use the <code>EnumMappingGenerator</code> custom mapping adapter. This adapter is pre-registered.</p>

<p>The <code>EnumMappingGenerator</code> custom mapping adapter uses the <code>valueOf(String)</code> and <code>name()</code> methods
of an enumeration to map to a string database column.</p>

<p>Registration of custom mapping adapter applies to all code generation in a application. To unregister an adapter use 
<code>QueryObjectFactory.registerMapper(String typeName)</code>.</p>

</div>

</div>
</div>


<div class="clear">
<hr />
</div>
<div id="footer">
<div class="right">&#169; 2007 brunella ltd</div>
<div class="clear">
<hr />
</div>
</div>


</body>
</html>