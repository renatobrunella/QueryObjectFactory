<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
		
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<link rel="stylesheet" type="text/css" href="qof.css" media="screen" title="qof" />
<link rel="stylesheet" type="text/css" href="qof-print.css" media="print" title="qof" />
<script src="codepress/codepress.js" type="text/javascript"></script>
<!--[if lt IE 7.]>
<script defer type="text/javascript" src="scripts/pngfix.js"></script>
<![endif]-->

<title>Query Object Factory - Tutorials</title>
</head>
<body>
<div id="masthead">
	<h1>
		<a href="http://sourceforge.net/">SourceForge.net</a>
	</h1>
	<div id="qoflogo">
		<a href="index.html"><img src="images/qof-line.png" border="0" />
		<img src="http://sflogo.sourceforge.net/sflogo.php?group_id=204175&amp;type=1" width="0" height="0" border="0" alt="" />
	</div>
</div>

<div id="leftColumn">
<div id="navColumn" style="height:2300px;">
<h1>About</h1>
<ul>
  <li class="none"><a href="index.html">Overview</a></li>
  <li class="none"><a href="introduction.html">Introduction</a></li>
  <li class="none"><a href="api/index.html">Javadoc</a></li>
  <li class="none"><a href="http://sourceforge.net/project/showfiles.php?group_id=204175#downloads">Downloads</a></li>
  <li class="none"><a href="http://sourceforge.net/news/?group_id=204175">News</a></li>
  <li class="none"><a href="faq.html">FAQ</a></li>
  <li class="none"><a href="license.html">License</a></li>
 <!--     
      <li class="none"><a href="goals.html">Our Goals</a></li>
   -->
</ul>

<h1>Tutorial</h1>
<ul>
  <li class="none"><a href="tutorials.html">Tutorials</a></li>
  <li class="none">&nbsp; &nbsp;<strong>Quick Start</strong></li>
  <li class="none"><a href="tutorial-immutable.html">&nbsp; &nbsp;Immutable Objects</a></li>
  <li class="none"><a href="tutorial-inclause.html">&nbsp; &nbsp;In-Clause</a></li>
</ul>

<h1>Core Concepts</h1>
<ul>
  <li class="none">Coming soon</li>
</ul>

<h1>Architecture</h1>
<ul>
  <li class="none">Coming soon</li>
</ul>

</div>
</div>

<div id="bodyColumn">
<div id="contentBox">
<div class="section">
<h2>Quick Start Tutorial</h2>

<p>Author: Renato Brunella</p>

<p>This tutorial takes the example from the Introduction and creates a running example in the form of a person 
repository. It creates a command line program that allows you to add, delete, change and search for persons in a database.</p>

</div>

<div class="section">
<h4>Tutorial Files</h4>
  
<p>You can find the source code in the 
<a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/quickstart/" target="_blank">Code Repository</a>
in the <code>sf.qof.tutorial.quickstart</code> package.</p>
<p>
<table>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/quickstart/PersonRepositoryExample.java?view=markup" target="_blank">PersonRepositoryExample.java&nbsp; &nbsp;</a></td>
<td>This file contains the main command line control loop and uses the PersonDAO implementation to add, delete and query persons
from the database.</td>
</tr>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/quickstart/PersonDAO.java?view=markup" target="_blank">PersonDAO.java</a></td>
<td>Query definition interface.</td>
</tr>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/quickstart/Person.java?view=markup" target="_blank">Person.java</a></td>
<td>A person JavaBean.</td>
</tr>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/quickstart/DatabaseSetup.java?view=markup" target="_blank">DatabaseSetup.java</a></td>
<td>Database setup.</td>
</tr>
</table>  
</div>

<div class="section">
<h4>Running the Tutorial</h4>

<p>Make sure you built the tutorial jar using Ant.<p>
<p>Use</p><code>java -cp dist/qof-tutorial-1.0.0.jar;lib/qof-1.0.0.jar;lib/cglib-2.1_3.jar;lib/asm-1.5.3.jar;lib/hsqldb.jar sf.qof.tutorial.quickstart.PersonRepositoryExample</code>
<p>to run the example (replace ; with : on Unix based systems).</p>
<p>Alternatively under Windows you can use the <code>run.bat</code> batch file:</p>
<code>run.bat sf.qof.tutorial.quickstart.PersonRepositoryExample</code>
</div>

<div class="section">
<h4>Source Code Walkthrough</h4>

<p>The <code>PersonRepositoryExample</code> class has a <code>main</code> method that creates a new instance of
<code>PersonRepositoryExample</code> and calls <code>doCommandLoop</code> the command loop waiting for some user input.</p>

<p>Initialization of the database and creation of a <code>PersonDAO</code> instance with connection is done in the constructor:</p>

<blockquote><pre>
  <b style="color:#7F0055;">private</b> PersonRepositoryExample() <b style="color:#7F0055;">throws</b> SQLException {
    DatabaseSetup.setup();
    personDao = QueryObjectFactory.createQueryObject(PersonDAO.<b style="color:#7F0055;">class</b>);
    Connection connection = DataSourceFactory.getDataSource().getConnection();
    connection.setAutoCommit(true);
    personDao.setConnection(connection);
  }
</pre></blockquote>

<p>In this example we use the database connection in auto-commit mode so we do not need to deal with transactions.
SQLExceptions that are thrown by <code>PersonDAO</code> are just re-thrown.</p>

<p>The private methods <code><b>addPerson()</b></code>, <code><b>deletePerson()</b></code>, etc in <code>PersonRepositoryExample</code>
are reading user input from the command line and invoking the corresponding method on the <code>PersonDAO</code> query object to 
query or update the database.</p>

<p>Let's have a look at the query definition interface <code>PersonDAO</code>:</p>

<textarea id="ta1" class="codepress java readonly-on" style="width:650px;height:650px;" wrap="off">
package sf.qof.tutorial.quickstart;

import java.sql.SQLException;
import java.util.List;

import sf.qof.*;

public interface PersonDAO extends BaseQuery {

  @Query(sql = "select id {%%.id}, first_name {%%.firstName}, last_name {%%.lastName}, " +
    "date_of_birth {%%.dateOfBirth} from person where id = {%1}")
  Person getPerson(int id) throws SQLException;

  @Query(sql = "select id {%%.id}, first_name {%%.firstName}, last_name {%%.lastName}, " +
    "date_of_birth {%%.dateOfBirth} from person")
  List<Person> listPersons() throws SQLException;

  @Query(sql = "select id {%%.id}, first_name {%%.firstName}, last_name {%%.lastName}, " +
    "date_of_birth {%%.dateOfBirth} from person where last_name like {%1}")
  List<Person> findPersons(String lastName) throws SQLException;
  
  @Insert(sql = "insert into person (id, first_name, last_name, date_of_birth) " +
    "values ({%1.id}, {%1.firstName}, {%1.lastName}, {%1.dateOfBirth})")
  void addPerson(Person person) throws SQLException;
  
  @Update(sql = "update person set first_name = {%1.firstName}, last_name = {%1.lastName}, " +
    "date_of_birth = {%1.dateOfBirth} where id = {%1.id}")
  int updatePerson(Person person) throws SQLException;
  
  @Delete(sql = "delete from person where id = {%1.id}")
  int deletePerson(Person person) throws SQLException;
  
  @Query(sql = "select max(id) + 1 as next_id {%%} from person")
  Integer nextId() throws SQLException;
}
</textarea>

<p>After you read the <a href="introduction.html">Introduction</a> most of the query definition methods 
should be easy to understand. There are two interesting details we will discuss below:</p>

<p>The <code><b>updatePerson(Person person)</b></code> and <code><b>deletePerson(Person person)</b></code>
methods both have a return type of <code><b>int</b></code> but there is not result definition in the
SQL statement. The reason for this is that update and delete query methods can not return result sets but
if you specify a return type of <code><b>int</b></code> (or <code><b>int[]</b></code> if a collection parameter 
is used) QueryObjectFactroy's implementation will return the update-count; that is the number of rows in the 
database table that were updated. We use this to find out if a person record for a given id was deleted or not:</p>

<blockquote><pre>
  <b style="color:#7F0055;">if</b> (personDao.deletePerson(<b style="color:#7F0055;">new</b> Person(id)) != 1) {
    System.out.println(<b style="color: #0000FF;font-weight:normal;">"Not found"</b>);
  }
</pre></blockquote>

<p>Another detail is the <code><b>nextId()</b></code> method:</p>

<blockquote><pre>
  @Query(sql = <b style="color: #0000FF;font-weight:normal;">"select max(id) + 1 as next_id {%%} from person"</b>)
  Integer nextId() <b style="color:#7F0055;">throws</b> SQLException;
</pre></blockquote>

<p>This method uses <code><b>Integer</b></code> as the result type rather than <code><b>int</b></code>. The reason for this is
that if the PERSON database table is empty the query will return an empty result set. Using <code><b>int</b></code>
as the result type would cause the implementation to throw a <code><b>SQLException</b></code> as it cannot return 
a useful result. But if the result type is <code><b>Integer</b></code> the implementation will return a <code><b>null</b></code>
value if no results can be found.</p>

<p>If the result types is a primitive (<code>int</code>, <code>double</code>, etc) the query method throws an exception
if the result set contains no rows whereas if the result type is an Java object (<code>String</code>, <code>Person</code>, etc.)
a <code><b>null</b></code> value is returned.</p>


</div>

</div>
</div>


<div class="clear">
<hr />
</div>
<div id="footer">
<div class="right">&#169; 2007 brunella ltd</div>
<div class="clear">
<hr />
</div>
</div>


</body>
</html>