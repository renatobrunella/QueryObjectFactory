<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
		
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<link rel="stylesheet" type="text/css" href="qof.css" media="screen" title="qof" />
<link rel="stylesheet" type="text/css" href="qof-print.css" media="print" title="qof" />
<script src="codepress/codepress.js" type="text/javascript"></script>
<!--[if lt IE 7.]>
<script defer type="text/javascript" src="scripts/pngfix.js"></script>
<![endif]-->

<title>Query Object Factory - Tutorials</title>
</head>
<body>
<div id="masthead">
	<h1>
		<a href="http://sourceforge.net/">SourceForge.net</a>
	</h1>
	<div id="qoflogo">
		<a href="index.html"><img src="images/qof-line.png" border="0" />
		<img src="http://sflogo.sourceforge.net/sflogo.php?group_id=204175&amp;type=1" width="0" height="0" border="0" alt="" />
	</div>
</div>

<div id="leftColumn">
<div id="navColumn" style="height:2300px;">
<h1>About</h1>
<ul>
  <li class="none"><a href="index.html">Overview</a></li>
  <li class="none"><a href="introduction.html">Introduction</a></li>
  <li class="none"><a href="api/index.html">Javadoc</a></li>
  <li class="none"><a href="http://sourceforge.net/project/showfiles.php?group_id=204175#downloads">Downloads</a></li>
  <li class="none"><a href="http://sourceforge.net/news/?group_id=204175">News</a></li>
  <li class="none"><a href="faq.html">FAQ</a></li>
  <li class="none"><a href="license.html">License</a></li>
 <!--     
      <li class="none"><a href="goals.html">Our Goals</a></li>
   -->
</ul>

<h1>Tutorial</h1>
<ul>
  <li class="none"><a href="tutorials.html">Tutorials</a></li>
  <li class="none"><a href="tutorial-quick-start.html">&nbsp; &nbsp;Quick Start</a></li>
  <li class="none"><a href="tutorial-immutable.html">&nbsp; &nbsp;Immutable Objects</a></li>
  <li class="none">&nbsp; &nbsp;<strong>In-Clause</strong></li>
</ul>

<h1>Core Concepts</h1>
<ul>
  <li class="none">Coming soon</li>
</ul>

<h1>Architecture</h1>
<ul>
  <li class="none">Coming soon</li>
</ul>

</div>
</div>

<div id="bodyColumn">
<div id="contentBox">
<div class="section">
<h2>In-Clause Tutorial</h2>

<p>Author: Renato Brunella</p>

<p>This tutorial demonstrates how SQL in-clauses work in QueryObjectFactory. The parameters for in-clauses get passed in as arrays. 
The example uses an employee/department relationship.</p>

</div>

<div class="section">
<h4>Tutorial Files</h4>
  
<p>You can find the source code in the 
<a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/inclause/" target="_blank">Code Repository</a>
in the <code>sf.qof.tutorial.inclause</code> package.</p>
<p>
<table>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/inclause/EmployeeRepositoryExample.java?view=markup" target="_blank">EmployeeRepositoryExample.java&nbsp; &nbsp;</a></td>
<td>Contains the main method.</td>
</tr>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/inclause/EmployeeDao.java?view=markup" target="_blank">EmployeeDao.java</a></td>
<td>An immutable currency object.</td>
</tr>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/inclause/Employee.java?view=markup" target="_blank">Employee.java</a></td>
<td>An employee bean.</td>
</tr>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/inclause/DepartmentCache.java?view=markup" target="_blank">DepartmentCache.java</a></td>
<td>A cache for departements.</td>
</tr>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/inclause/Department.java?view=markup" target="_blank">Department.java</a></td>
<td>An immutable department object.</td>
</tr>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/inclause/DepartmentAdapter.java?view=markup" target="_blank">DepartmentAdapter.java</a></td>
<td>A custom mapping adapter for departments.</td>
</tr>
<tr>
<td><a href="http://qof-jdbc.cvs.sourceforge.net/qof-jdbc/qof-tutorial/src/sf/qof/tutorial/inclause/DatabaseSetup.java?view=markup" target="_blank">DatabaseSetup.java</a></td>
<td>Database setup.</td>
</tr>
</table>  
</div>

<div class="section">
<h4>Running the Tutorial</h4>

<p>Make sure you built the tutorial jar using Ant.<p>
<p>Use</p><code>java -cp dist/qof-tutorial-1.0.0.jar;lib/qof-1.0.0.jar;lib/cglib-2.1_3.jar;lib/asm-1.5.3.jar;lib/hsqldb.jar sf.qof.tutorial.inclause.EmployeeRepositoryExample</code>
<p>to run the example (replace ; with : on Unix based systems).</p>
<p>Alternatively under Windows you can use the <code>run.bat</code> batch file:</p>
<code>run.bat sf.qof.tutorial.inclause.EmployeeRepositoryExample</code>
</div>

<div class="section">
<h4>Source Code Walkthrough</h4>

<p>The <code>DatabaseSetup</code> class creates two tables DEPARTMENT and EMPLOYEE and inserts six department
records and create 100 random employees. Each employee belongs to one department.</p>

<p><code>DepartmentCache</code> class uses the Singleton pattern. During initialization it reads all rows from the DEPARTMENT table 
and caches the <code>Department</code> objects in a map. It uses the <code>DepartmentDao</code> query definition
interface:</p>

<blockquote><pre>
  <b style="color:#7F0055;">private</b> <b style="color:#7F0055;">interface</b> DepartmentDao <b style="color:#7F0055;">extends</b> BaseQuery {
    @Query(sql = <b style="color: #0000FF;font-weight:normal;">"select code {string%%1,%%*}, name {string%%2} from department"</b>)
    Map&lt;String, Department&gt; retrieveDepartments() <b style="color:#7F0055;">throws</b> SQLException;
  }
</pre></blockquote>

<p><code>DepartmentCache</code> class provides the <code>findDepartment(String code)</code> and <code>getDepartments()</code>
methods to find and list <code>Department</code> objects.<p>

<p>The <code>main</code> method in <code>EmployeeRepositoryExample</code> prints a list of all departments and asks the
user to input a comma-separated list of department code. It then creates a string array of department codes and uses
it as a parameter for the <code>getEmployeesByDepartment</code> defined in <code>EmployeeDao</code> query definition
interface:</p>

<textarea id="ta1" class="codepress java readonly-on" style="width:650px;height:400px;" wrap="off">
package sf.qof.tutorial.inclause;

import java.sql.SQLException;
import java.util.List;

import sf.qof.*;

public interface EmployeeDao extends BaseQuery {
  
  @Query(sql = "select id {%%.id}, first_name {%%.firstName}, " +
    "last_name {%%.lastName}, department_code {department%%.department} " +
    "from employee where department_code in ({%1}) " +
	"order by last_name, first_name")
  List<Employee> getEmployeesByDepartment(String[] departmentCodes) throws SQLException;

  @Query(sql = "select id {%%.id}, first_name {%%.firstName}, " +
    "last_name {%%.lastName}, department_code {department%%.department}" +
    "from employee where department_code in ({department%1}) " +
	"order by last_name, first_name")
  List<Employee> getEmployeesByDepartment(Department[] departments) throws SQLException;
}
</textarea>

<p>QueryObjectFactory supports parameters in SQL in-clauses like "<code>where department_code in ({%1})</code>" 
through Java arrays. It creates a prepared statement with as many SQL parameters as there are elements in the
array.</p>

<p>For example if there are three strings in the <code>departmentCodes</code> array it creates a SQL statement
with three SQL parameters ("<code>where department_code in (?,?,?)</code>") and bind the values in the array to the parameters.</p>

<p><code>EmployeeDao</code> also uses a mapping adapter to map between <code>department_code</code> column and
<code>Department</code> objects. The <code>DepartmentAdapter</code> class is responsible for this.</p>
<p><code>DepartmentAdapter</code> implements the <code>DynamicMappingAdapter</code> interface:</p>

<textarea id="ta2" class="codepress java readonly-on" style="width:650px;height:330px;" wrap="off">
...
public Object get(ResultSet rs, String[] columns) throws SQLException {
  String code = rs.getString(columns[0]);
  if (code == null) {
    return null;
  } else {
    return DepartmentCache.getInstance().findDepartment(code);
  }
}

public void set(PreparedStatement ps, Object value, int[] indexes) throws SQLException {
  if (value == null) {
    ps.setNull(indexes[0], java.sql.Types.VARCHAR);
  } else {
    ps.setString(indexes[0], ((Department)value).getCode());
  }
}
...
</textarea>

<p>The <code>get</code> method is responsible to map a SQL column in a result set to an <code>Department</code>
object. The adapter uses the <code>DepartmentCache</code> singleton to map a department code to a <code>Department</code>
object.</p>

<p>The <code>set</code> method is responsible to map a <code>Department</code> object to a prepared statment.</p>

<p>A special tutorial will give more infomation on how to write custom adapters.</p>

</div>

</div>
</div>


<div class="clear">
<hr />
</div>
<div id="footer">
<div class="right">&#169; 2007 brunella ltd</div>
<div class="clear">
<hr />
</div>
</div>


</body>
</html>