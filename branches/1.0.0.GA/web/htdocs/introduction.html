<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
		
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
<link rel="stylesheet" type="text/css" href="qof.css" media="screen" title="qof" />
<link rel="stylesheet" type="text/css" href="qof-print.css" media="print" title="qof" />
<script src="codepress/codepress.js" type="text/javascript"></script>
<!--[if lt IE 7.]>
<script defer type="text/javascript" src="scripts/pngfix.js"></script>
<![endif]-->

<title>Query Object Factory - Introduction</title>
</head>
<body>
<div id="masthead">
	<h1>
		<a href="http://sourceforge.net/">SourceForge.net</a>
	</h1>
	<div id="qoflogo">
		<a href="index.html"><img src="images/qof-line.png" border="0" />
		<img src="http://sflogo.sourceforge.net/sflogo.php?group_id=204175&amp;type=1" width="0" height="0" border="0" alt="" />
	</div>
</div>

<div id="leftColumn">
<div id="navColumn" style="height:3400px;">
<h1>About</h1>
<ul>
  <li class="none"><a href="index.html">Overview</a></li>
  <li class="none"><strong>Introduction</strong></li>
  <li class="none"><a href="api/index.html">Javadoc</a></li>
  <li class="none"><a href="http://sourceforge.net/project/showfiles.php?group_id=204175#downloads">Downloads</a></li>
  <li class="none"><a href="http://sourceforge.net/news/?group_id=204175">News</a></li>
  <li class="none"><a href="faq.html">FAQ</a></li>
  <li class="none"><a href="license.html">License</a></li>
 <!--     
      <li class="none"><a href="goals.html">Our Goals</a></li>
   -->
</ul>

<h1>Tutorial</h1>
<ul>
  <li class="none"><a href="tutorials.html">Tutorials</a></li>
</ul>

<h1>Core Concepts</h1>
<ul>
  <li class="none">Coming soon</li>
</ul>

<h1>Architecture</h1>
<ul>
  <li class="none">Coming soon</li>
</ul>

</div>
</div>

<div id="bodyColumn">
<div id="contentBox">
<div class="section">
<h2>Introduction</h2>

<p>Author: Renato Brunella</p>

<p>This is a quick introduction to QueryObjectFactory's most important features. 
Read through it to get an idea of what QueryObjectFactory is and isn't.</p>
</div>

<div class="section">
<h3>Basics</h3>
<p>QueryObjectFactory is a fast, lightweight runtime JDBC code generator. In this section we
will have a look at the basic functionality that QueryObjectFactory provides for CRUD operations
i.e. SQL select, insert, update and delete statements.</p>

<p>Let's start with an easy example: We have a table PERSON that has three column:</p>

<pre><blockquote>
<b>CREATE TABLE</b> PERSON (
  id         NUMERIC(5),
  first_name VARCHAR(20),
  last_name  VARCHAR(20),
  <b>PRIMARY KEY</b> (id)
)
</blockquote></pre>

<p>Next we define a Java class <code><b>Person</b></code> that has public getters and setters for three fields
that we want map to the columns in table PERSON:</p>

<textarea id="ta1" class="codepress java readonly-on" style="width:650px;height:250px;" wrap="off">
package sf.qof.intro;

public class Person {
  private int id;
  private String firstName;
  private String lastName;
  public void setId(int id) { this.id = id; }
  public int getId() { return id; }
  public void setFirstName(String firstName) { this.firstName = firstName; }
  public String getFirstName() { return firstName; }
  public void setLastName(String lastName) { this.lastName = lastName; }
  public String getLastName() { return lastName; }
}
</textarea>

<p>So far we didn't do anything special. Now is the time to create our first query object definition interface.
This interface provides a specification that allows QueryObjectFactory to implement a query object class for us.</p>

<p>Let's call the interface <code><b>PersonDao</b></code> and add methods to retrieve, add, update and delete 
<code><b>Person</b></code> objects to the PERSON table.</p>
<p>The necessary mapping information that binds parameters and results from SQL statements to the Java object
must be specified using Java annotations:</p>

<textarea id="ta2" class="codepress java readonly-on" style="width:650px;height:370px;" wrap="off">
package sf.qof.intro;

import java.sql.SQLException;
import sf.qof.*;

public interface PersonDao extends BaseQuery {
  @Query(sql = "select id {%%.id}, first_name {%%.firstName}, " +
    "last_name {%%.lastName} from PERSON where id = {%1}")
  Person getPerson(int id) throws SQLException;
  
  @Insert(sql = "insert into PERSON (id, first_name, last_name) " +
    "values ({%1.id}, {%1.firstName}, {%1.lastName})")
  void insertPerson(Person person) throws SQLException;
  
  @Update(sql = "update PERSON set first_name = {%1.firstName}, " +
    "last_name = {%1.lastName} where id = {%1.id}")
  void updatePerson(Person person) throws SQLException;
  
  @Delete(sql = "delete from PERSON where id = {%1.id}")
  void deletePerson(Person person) throws SQLException;
}
</textarea>

<p>For CRUD operations there are four annotations available: <b>@Insert</b>, <b>@Query</b>, <b>@Update</b> and 
<b>@Delete</b>. Each of them requires at least the definition of a SQL statement (sql = "..."). Parameter and 
result mappings are defined within the SQL statements in curly brackets: <code><b>{%%.id}</b></code> etc.</p>

<p>A parameter mapping is defined by a percent character followed by a number that defines the position of the parameter
in the query method. For example in the <code><b>getPerson</b></code> query method <code><b>{%1}</b></code> refers to
the <code><b>id</b></code> parameter. To map parameters that refer to a field within a Java object you need to 
add a dot and the name of the field: <code><b>{%1.firstName}</b></code>. There must be a public getter method 
defined for that field <code><b>String Person.getFirstName()</b></code> according to the JavaBean specification.</p>

<p>QueryObjectFactory is able to determine the type of the parameter for all primitive Java types and their boxed 
version (<code>int</code>, <code>Integer</code>, <code>String</code>, <code>Date</code> etc.) It uses reflection to do this.
Sometimes it is necessary to explicitly specify the type and in this case you add it before the percent character:
<code><b>{int%1}</b></code>. More on this and a list of all supported predefined mapping options can be found in
the <a href="api/index.html">API documentation</a> and the tutorial.</p>

<p>A result mapping is defined similar to a parameter definition by two percent characters: <code><b>{%%}</b></code>.
If the result of the query method is a JavaBean object we can specify which field in the object we want to map to.
In the example above we want to map the <code><b>last_name</b></code> column returned by the SQL select statement
to the field <code><b>lastName</b></code>. We do this by adding a dot followed by the field name to the result 
mapping: <code><b>{%%.lastName}</b></code>. There must be a public setter method defined for that field 
<code><b>void Person.setLastName(String lastName)</b></code> according to the JavaBean specification.</p>

<p>The interface that defines the query methods should normally extend the <code><b>BaseQuery</b></code> interface.
This interface defines methods to set the database connection, fetch size and batch size. QueryObjectFactory will
always implement these methods regardless if the interface extends <code><b>BaseQuey</b></code> or not.</p>

<p>All query methods should have a <code><b>throws SQLException</b></code> clause to enable proper exception handling.</p>

<p>Now that we understand the basics of how to map parameters and results we want to use QueryObjectFactory to implement
the <code><b>PersonDao</b></code> interface for us:</p>

<textarea id="ta3" class="codepress java readonly-on" style="width:650px;height:470px;" wrap="off">
package sf.qof.intro;

import java.sql.*;
import sf.qof.*;

public class PersonDaoTest {
  public static void main(String[] args) throws SQLException {
    PersonDao personDao = 
	    QueryObjectFactory.createQueryObject(PersonDao.class);
    Connection connection = newConnection();
    try {
      personDao.setConnection(connection);
      Person person = personDao.getPerson(1);
	  if (person == null) {
	    System.out.println("Not found");
	  } else {
	    System.out.println(person.getFirstName() + " " + person.getLastName());
	  }
    } finally {
      connection.close();
    }
  }
  
  private static Connection newConnection() throws SQLException {
    // returns a new database connection
  }
}
</textarea>

<p>The call to <code><b>QueryObjectFactory.createQueryObject(PersonDao.class)</b></code> will return an instance of
a class that implements the <code><b>PersonDao</b></code> interface. QueryObjectFactory caches generated class 
therefore only the first call to implement a certain query interface will use code generation. Subsequent calls
simply create a new instance of the class which greatly enhances performance.</p>

<p>Now that we have an object that implements <code><b>PersonDao</b></code> we just need to set the database 
connection using <code><b>personDao.setConnection()</b></code> and we are ready to run the first query.</p>

<p>The call to <code><b>personDao.getPerson(1)</b></code> will return a new <code><b>Person</b></code> object if there is a 
row in the PERSON table with id = 1 or null if no result was found or throws a SQLException if more than one result can be found.<p>
</div>

<div class="section">
<h3>Java Collections</h3>

<p>QueryObjectFactory provides powerful support for Java collections both as parameters and results.
Java Collections that are supported are <code><b>java.util.List</b></code>, <code><b>java.util.Set</b></code> and
<code><b>java.util.Map</b></code>.</p>

<p>For example to have a method that returns a list of persons with a given last name we simply need to add:

<blockquote><pre>
    @Query(sql = <b style="color: #0000FF;font-weight:normal;">"select id {%%.id}, first_name {%%.firstName}, " +
        "last_name {%%.lastName} from PERSON where last_name = {%1}"</b>)
    List&lt;Person&gt; findPersonByLastName(String lastName) <b style="color:#7F0055;">throws</b> SQLException;
</pre></blockquote>

<p>to <code><b>PersonDao</b></code>. QueryObjectFactory will implement a method that returns a list of 
<code><b>Person</b></code> objects.</p>

<p>The <code><b>BaseQuery</b></code> interface provides a method <code><b>setFetchSize(int)</b></code> that
allows to set how many records should be fetched from the database at one time to enhance performance in
large result sets.<p>

<p>Collections that are passed in as parameters will be implemented using batch processing:</p>

<blockquote><pre>
    @Insert(sql = <b style="color: #0000FF;font-weight:normal;">"insert into PERSON (id, first_name, last_name) " +
        "values ({%1.id}, {%1.firstName}, {%1.lastName})"</b>)
    void insertPersons(List&lt;Person&gt; personList) <b style="color:#7F0055;">throws</b> SQLException;
</pre></blockquote>

<p>In the method above you can pass in a list of <code><b>Person</b></code> objects that get inserted into
the PERSON table using batch processing to enhance performance.</p>

<p>The <code><b>BaseQuery</b></code> interface provides a method <code><b>setBatchSize(int)</b></code> that
allows to set how many records should sent in a batch to the database.<p>

<p>For more details check the tutorial section.</p>

</div>

<div class="section">
<h3>Required libraries</h3>

<p>The following library files need to be on the classpath:</p>
<ul>
  <li>qof-RC3-1.0.0.jar</li>
  <li>cglib-2.1_3.jar</li>
  <li>asm-1.5.3.jar</li>
</ul>
<p>Alternatively there is a library file without external dependencies:</p>
<ul>
  <li>qof-nodependency-RC3-1.0.0.jar</li>
</ul>

<p>QueryObjectFactory uses Code Generation Library (cglib) and ASM for the byte-code generation. Therefore 
these two components as well as the qof-library need to be on the classpath.</p>

<p>You can find all necessary libraries in the <a href="http://sourceforge.net/project/showfiles.php?group_id=204175#downloads">Download Section</a>.
</p>
</div>

</div>
</div>
</div>


<div class="clear">
<hr />
</div>
<div id="footer">
<div class="right">&#169; 2007 brunella ltd</div>
<div class="clear">
<hr />
</div>
</div>


</body>
</html>